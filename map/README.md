# Story Map Visualization

Interactive web map for exploring 388 stories from "Apple in China" with 448 geocoded locations spanning 1976-2018.

## Features

- **Map-first interface**: Full-screen Google Maps with dark theme
- **Smart clustering**: Automatically groups nearby stories, with LLM-generated summaries
- **Zoom-based rendering**: Shows clusters at low zoom, individual stories at street level
- **Timeline visualization**: Interactive timeline for multi-story clusters
- **Story details**: Click any story to see full title + summary

## Architecture

```
Frontend (Svelte + Google Maps)
        ↓
Backend (FastAPI + SQLite)
        ↓
Database (stories + location_clusters tables)
```

## Setup

### 1. Prerequisites

- Python 3.11+
- Node.js 18+
- Google Maps API key
- OpenAI API key (for cluster generation)

### 2. Backend Setup

```bash
# Install Python dependencies
cd map
pip install -r requirements.txt

# Generate clusters (one-time, uses GPT-5-mini)
cd ..
abxgeo cluster --db full_book.sqlite

# Estimated cost: $0.10-0.30
# Estimated time: 2-5 minutes
```

### 3. Frontend Setup

```bash
cd map/frontend

# Install dependencies
npm install

# Configure environment variables
cp .env.example .env
# Edit .env and add your Google Maps API key
```

### 4. Running

**Terminal 1: Start API server**

```bash
cd map
python server.py
```

Server runs on `http://localhost:8000`

**Terminal 2: Start frontend dev server**

```bash
cd map/frontend
npm run dev
```

Frontend runs on `http://localhost:5173`

Open `http://localhost:5173` in your browser.

## Environment Variables

### Backend

None required (reads from `../full_book.sqlite` by default)

### Frontend (`.env`)

```
VITE_GOOGLE_MAPS_API_KEY=your_google_maps_api_key_here
VITE_API_BASE_URL=http://localhost:8000
```

## API Endpoints

### `GET /api/locations`

Get locations or clusters for current viewport.

**Parameters:**
- `zoom` (int): Current zoom level (1-18)
- `sw_lat` (float): Southwest latitude
- `sw_lon` (float): Southwest longitude
- `ne_lat` (float): Northeast latitude
- `ne_lon` (float): Northeast longitude

**Response:**
```json
{
  "locations": [...],  // if zoom >= 12
  "clusters": [...]    // if zoom < 12
}
```

### `GET /api/story/{story_id}`

Get full story details.

**Response:**
```json
{
  "story_id": "...",
  "title": "...",
  "summary": "...",
  "parsed_date": "...",
  "locations": [...],
  "people": [...],
  "companies": [...],
  "products": [...]
}
```

### `GET /api/cluster/{cluster_id}`

Get cluster details with all stories.

**Response:**
```json
{
  "cluster_id": "...",
  "center_lat": 37.33,
  "center_lon": -122.03,
  "summary": "LLM-generated narrative summary...",
  "key_themes": ["theme1", "theme2"],
  "story_count": 15,
  "date_range": "1998-1999",
  "stories": [...]
}
```

## Database Schema

### `location_clusters` (generated by `abxgeo cluster`)

```sql
CREATE TABLE location_clusters (
  cluster_id TEXT PRIMARY KEY,
  center_lat REAL NOT NULL,
  center_lon REAL NOT NULL,
  zoom_level INTEGER,
  story_ids_json TEXT NOT NULL,
  summary TEXT NOT NULL,
  key_themes_json TEXT,
  story_count INTEGER NOT NULL,
  date_range TEXT,
  created_at TEXT DEFAULT (datetime('now'))
);
```

## Development

### Regenerate Clusters

```bash
abxgeo cluster --db full_book.sqlite --force
```

### Build Frontend for Production

```bash
cd map/frontend
npm run build

# Output in dist/
```

### Serve Production Build

Option 1: Static file server

```bash
npx serve -s dist -p 5173
```

Option 2: Integrate with FastAPI (TODO)

## Troubleshooting

### "No clusters found"

- Run `abxgeo cluster --db full_book.sqlite` first
- Check that `location_clusters` table exists:
  ```bash
  sqlite3 full_book.sqlite "SELECT COUNT(*) FROM location_clusters"
  ```

### "Google Maps not loading"

- Verify `VITE_GOOGLE_MAPS_API_KEY` is set in `.env`
- Check that Maps JavaScript API is enabled in Google Cloud Console
- Open browser console for error messages

### "API errors" (CORS/connection refused)

- Ensure backend server is running on port 8000
- Check `VITE_API_BASE_URL` in frontend `.env`
- Verify CORS origins in `server.py` match your frontend URL

## Next Steps (Phase 2)

- Timeline slider filter (filter stories by date range)
- People/company/product search
- Cross-location narrative connections
- Share/export functionality
- Mobile/touch optimizations

## Tech Stack

- **Frontend**: Svelte 4, Vite, Google Maps JavaScript API
- **Backend**: FastAPI, Python 3.13
- **Database**: SQLite with FTS5
- **Clustering**: scikit-learn (DBSCAN), GPT-5-mini (summaries)

## Performance

- Initial load: < 2 seconds
- Marker render: < 500ms
- API response: < 200ms
- Smooth 60fps pan/zoom

## Cost

- **Cluster generation** (one-time): $0.10-0.30
- **Map usage** (runtime): Free (uses Google Maps API, stays within free tier for development)
- **No LLM calls at runtime**: All summaries pre-computed

See `../map.prd` for full product requirements.
